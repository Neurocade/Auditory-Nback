<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attention Training Program</title>

<style>
/* ========================================================
SENIOR FRIENDLY DESIGN
Large fonts, high contrast, low clutter
======================================================== */

body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    justify-content: center;
    padding-top: 30px;
}

#app {
    width: 850px;
    background: #1e1e1e;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
}

h1 { font-size: 34px; }
h2 { font-size: 26px; }

button {
    font-size: 22px;
    padding: 14px 24px;
    margin: 10px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: #444;
    color: white;
}

#startBtn { background: #4caf50; color: black; font-weight: bold; }

#matchBtn {
    font-size: 30px;
    background: #4caf50;
    color: black;
    cursor: pointer;
    border: none;
    border-radius: 10px;
    padding: 20px 40px;
}

/* ================================
VISUAL FEEDBACK WHEN BUTTON PRESSED
Makes the MATCH button flash when clicked
================================ */

#matchBtn.pressed {
    background: #2ecc71;     /* Brighter green */
    transform: scale(0.95);  /* Slight press-in effect */
    transition: transform 0.1s ease, background 0.1s ease;
}

select {
    font-size: 20px;
    padding: 8px;
    margin: 6px;
    background: #333;
    color: white;
}

#fixation {
    font-size: 120px;
    margin: 30px 0;
    color: #bbb;
}

#results {
    display: none;
    font-size: 22px;
}

.encouragement {
    font-size: 26px;
    margin-top: 15px;
    color: #7CFF7C;
}

#instructionsBox {
    background: #222;
    padding: 20px;
    border-radius: 10px;
    font-size: 22px;
    margin-top: 20px;
    text-align: left;
}

.settings-group {
    border: 1px solid #444;
    padding: 15px;
    margin: 20px 0;
    border-radius: 10px;
    background: #252525;
}
</style>
</head>

<body>
<div id="app">

<h1>Attention Training</h1>

<div id="menu">

<div id="progressSummary"></div>

<div class="settings-group">
    <label>
    <input type="checkbox" id="timerMode">
      15-Minute Structured Session Mode
    </label>

    <br><br>

    <label for="levelSelect">Select Starting Level (1 = easiest, 6 = very challenging): </label>
    <select id="levelSelect">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
    </select>
</div>

<br><br>
<button id="startBtn">Start Training</button>

</div>

<div id="instructions" style="display:none;">
    <div id="instructionsBox"></div>
    <br>
    <button id="beginTaskBtn">Begin Task</button>
</div>

<div id="task" style="display:none;">
<h2 id="levelLabel"></h2>
<div id="fixation">+</div>
<button id="matchBtn">MATCH</button>
</div>

<div id="results"></div>

</div>

    <div id="customModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#222; padding:30px; border-radius:12px; width:500px; text-align:center;">
        <p id="modalMessage" style="font-size:22px;"></p>
        <br>
        <button id="modalYesBtn" style="background:#4caf50; color:black;">Yes</button>
        <button id="modalNoBtn" style="background:#f44336; color:white;">No</button>
    </div>
</div>
    
<script>

/* ========================================================
GLOBAL VARIABLES
======================================================== */

let trialTimeout = null;  
let n = 1;                
let isi = 2500;           
let trials = 30;          
let sequence = [];
let index = 0;
let results = [];
let trialActive = false;
let sessionStartTime = 0;
let timerMode = false;
let totalSessionAccuracy = [];
let lastRoundAccuracy = 0; 

/* [NEW] ADVANCED CROSS-PLATFORM SPEECH SYSTEM 
This system uses a more aggressive buffer-clearing technique specifically 
for Windows to eliminate digital distortion. It prioritizes Samantha for 
iOS and Microsoft's "Natural" voices for Windows.
*/
let selectedVoice = null;

function loadVoices() {
    const voices = window.speechSynthesis.getVoices();
    
    // 1. Try to find Samantha (iOS Gold Standard)
    let samantha = voices.find(v => v.name.includes("Samantha"));
    
    // 2. Try to find Windows "Natural" (Highest quality PC voices)
    let windowsNatural = voices.find(v => v.name.includes("Natural") && v.lang.includes("en-US"));
    
    // 3. Try standard American English (David/Zira/Google US)
    let americanFallback = voices.find(v => v.lang === "en-US" || v.lang === "en_US");

    selectedVoice = samantha || windowsNatural || americanFallback || voices[0];
}

// Fixed: iOS and Chrome need this to fire multiple times to catch voices
if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = loadVoices;
}
loadVoices();

// Windows-specific keep-alive: prevents the engine from entering a low-power "crackle" state
setInterval(() => {
    if (window.speechSynthesis && !window.speechSynthesis.speaking) {
        window.speechSynthesis.pause();
        window.speechSynthesis.resume();
    }
}, 5000);

/* ========================================================
PROGRESS TRACKING SYSTEM
Tracks sessions, best level, average, last round, best ever
======================================================== */

function loadProgress() {
    let data = JSON.parse(localStorage.getItem("attentionProgress"));
    if (!data) {
        data = {
            sessions: 0,
            bestLevel: 1,
            accuracyHistory: [],
            bestAccuracyEver: 0,
            lastRoundAccuracy: 0
        };
    }
    return data;
}

function saveProgress(level, accuracy) {
    let data = loadProgress();
    data.sessions += 1;
    data.bestLevel = Math.max(data.bestLevel, level);
    data.accuracyHistory.push(accuracy);
    data.lastRoundAccuracy = accuracy;
    if (accuracy > data.bestAccuracyEver) data.bestAccuracyEver = accuracy;
    localStorage.setItem("attentionProgress", JSON.stringify(data));
}

function displayProgress() {
    let data = loadProgress();
    let avg = 0;
    if (data.accuracyHistory.length > 0) {
        avg = Math.round(data.accuracyHistory.reduce((a,b)=>a+b,0) / data.accuracyHistory.length);
    }
    document.getElementById("progressSummary").innerHTML = `
        <h2>Your Progress</h2>
        Sessions Completed: ${data.sessions}<br>
        Best Level Reached: ${data.bestLevel}-back<br>
        Average Accuracy: ${avg}%<br>
        Last Round Accuracy: ${data.lastRoundAccuracy}%<br>
        Best Ever Accuracy: ${data.bestAccuracyEver}%<br><br>
    `;
}

displayProgress();

/* ========================================================
INSTRUCTION TEXT PER LEVEL
======================================================== */

const instructionPhrases = {
    1: "the one just before it",
    2: "the one two letters ago",
    3: "the one three letters ago",
    4: "the one four letters ago",
    5: "the one five letters ago",
    6: "the one six letters ago"
};

/* ========================================================
SEQUENCE BUILDER (~30% targets, max 2 in row)
======================================================== */

const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

function buildSequence(trials, n) {
    let seq = [];
    let targetIndices = new Set();
    let validSlots = trials - n;
    let desiredTargets = Math.round(validSlots * 0.30);

    while (targetIndices.size < desiredTargets) {
        let pos = Math.floor(Math.random() * validSlots) + n;
        if (targetIndices.has(pos-1) && targetIndices.has(pos-2)) continue;
        targetIndices.add(pos);
    }

    for (let i = 0; i < trials; i++) {
        if (i < n) {
            seq.push(randomLetter());
        } else if (targetIndices.has(i)) {
            seq.push(seq[i-n]);
        } else {
            let options = LETTERS.filter(x => x !== seq[i-n]);
            seq.push(options[Math.floor(Math.random() * options.length)]);
        }
    }
    return seq;
}

function randomLetter() {
    return LETTERS[Math.floor(Math.random() * LETTERS.length)];
}

/* ========================================================
START BUTTON HANDLER (SHOW INSTRUCTIONS)
======================================================== */

document.getElementById("startBtn").addEventListener("click", () => {
    n = parseInt(document.getElementById("levelSelect").value);
    showInstructions(n);
});

function showInstructions(level) {
    document.getElementById("menu").style.display = "none";
    const instrText = `
    <strong>Instructions:</strong><br><br>
    You will hear a sequence of letters, one at a time.<br>
    Listen carefully and press the MATCH button when the current letter matches ${instructionPhrases[level]}.<br>
    You can press the MATCH button by <strong>clicking it</strong> or <strong>pressing the spacebar</strong>.<br><br>
    Click "Begin Task" when you are ready.
    `;
    document.getElementById("instructionsBox").innerHTML = instrText;
    document.getElementById("instructions").style.display = "block";
}

document.getElementById("beginTaskBtn").addEventListener("click", () => {
    document.getElementById("instructions").style.display = "none";
    document.getElementById("task").style.display = "block";
    timerMode = document.getElementById("timerMode").checked;
    sessionStartTime = Date.now();
    totalSessionAccuracy = [];
    runBlock();
});

/* ========================================================
RUN ONE BLOCK
======================================================== */

function runBlock() {
    if (trialTimeout) {
        clearTimeout(trialTimeout);
        trialTimeout = null;
    }
    document.getElementById("levelLabel").textContent = "Level: " + n + "-back";
    sequence = buildSequence(trials, n);
    index = 0;
    results = [];
    nextTrial();
}

/* ========================================================
TRIAL LOOP
======================================================== */

function nextTrial() {
    if (index >= sequence.length) {
        endBlock();
        return;
    }
    trialActive = true;
    let letter = sequence[index];
    speak(letter);

    results.push({
        target: (index >= n && letter === sequence[index-n]),
        responded: false
    });

    trialTimeout = setTimeout(() => {
        trialActive = false;
        index++;
        nextTrial();
    }, isi);
}

/* [NEW] ENHANCED SPEAK FUNCTION FOR WINDOWS
Increases the "silence gap" between letters to 100ms. This prevents the 
Windows speech synthesizer from clipping or sounding digital by giving 
the hardware buffer extra time to fully clear.
*/
function speak(letter) {
    // Stop all speech and clear current buffer
    window.speechSynthesis.cancel();
    
    // Increased wait time (100ms) specifically helps Windows sound drivers "reset"
    setTimeout(() => {
        const utter = new SpeechSynthesisUtterance(letter.toLowerCase());
        if (selectedVoice) utter.voice = selectedVoice;
        
        // Rate 0.9 is the "Sweet Spot" for clarity on letters like 'B' and 'D'
        utter.rate = 0.9;
        utter.pitch = 1.0;
        utter.volume = 1.0;
        
        window.speechSynthesis.speak(utter);
    }, 100); 
}

/* ========================================================
MATCH BUTTON / SPACEBAR RESPONSE
======================================================== */

function registerResponse() {
    if (!trialActive) return;
    results[index].responded = true;

    // Visual feedback
    const btn = document.getElementById("matchBtn");
    btn.classList.add("pressed");
    setTimeout(() => btn.classList.remove("pressed"), 150);
}

document.getElementById("matchBtn").addEventListener("click", registerResponse);

document.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
        e.preventDefault();
        registerResponse();
    }
});

/* ========================================================
CUSTOM MODAL LOGIC (Replaces confirm popup)
======================================================== */

function showIncreaseModal(callbackYes, callbackNo) {
    document.getElementById("modalMessage").textContent = "Excellent focus! Do you want to increase the level?";
    const modal = document.getElementById("customModal");
    modal.style.display = "flex";

    document.getElementById("modalYesBtn").onclick = function() {
        modal.style.display = "none";
        callbackYes();
    };

    document.getElementById("modalNoBtn").onclick = function() {
        modal.style.display = "none";
        callbackNo();
    };
}
    
/* ========================================================
END BLOCK + ADAPTIVE DIFFICULTY
======================================================== */

function endBlock() {
    if (trialTimeout) {
        clearTimeout(trialTimeout);
        trialTimeout = null;
    }

    let hits = 0;
    let totalTargets = 0;

    results.forEach(r => {
        if (r.target) {
            totalTargets++;
            if (r.responded) hits++;
        }
    });

    let accuracy = totalTargets === 0 ? 0 : Math.round((hits / totalTargets) * 100);
    lastRoundAccuracy = accuracy;
    totalSessionAccuracy.push(accuracy);

    // Adaptive logic (max 6, min 1)
    if (accuracy >= 85 && n < 6) {
        showIncreaseModal(
            function() {
                n++;
                showLevelReminder(n);
            },
            function() {
                continueAfterAdaptive();
            }
        );
        return; 
    } else if (accuracy < 60 && n > 1) {
        n--;
        showLevelReminder(n);
        return;
    }
    continueAfterAdaptive();
}

/* ========================================================
SHORT LEVEL REMINDER AFTER ADAPTIVE CHANGE
======================================================== */

function showLevelReminder(level) {
    const instrText = `
    <strong>Level Reminder:</strong><br><br>
    You are now at Level ${level} — press MATCH when the current letter matches ${instructionPhrases[level]}.<br>
    Click "Begin Task" when ready.
    `;
    document.getElementById("instructionsBox").innerHTML = instrText;
    document.getElementById("instructions").style.display = "block";

    document.getElementById("beginTaskBtn").onclick = () => {
        document.getElementById("instructions").style.display = "none";
        runBlock();
    };
}

/* ========================================================
END SESSION + SAVE PROGRESS
======================================================== */

function endSession() {
    document.getElementById("task").style.display = "none";
    let resultsDiv = document.getElementById("results");
    resultsDiv.style.display = "block";

    let avgAccuracy = Math.round(
        totalSessionAccuracy.reduce((a,b)=>a+b,0) / totalSessionAccuracy.length
    );

    saveProgress(n, avgAccuracy);

    let message =
        avgAccuracy >= 85 ? "Excellent focus today!" :
        avgAccuracy >= 70 ? "Nice steady progress!" :
        "Keep practicing — attention improves with training.";

    resultsDiv.innerHTML = `
    <h2>Session Complete</h2>
    Average Accuracy: ${avgAccuracy}%<br>
    Last Round Accuracy: ${lastRoundAccuracy}%<br>
    Final Level Reached: ${n}-back<br>
    <div class="encouragement">${message}</div>
    <button onclick="location.reload()">Train Again</button>
`;
}

function continueAfterAdaptive() {
    // Timer mode: auto continue until 15 min
    if (timerMode && Date.now() - sessionStartTime < 900000) {
        runBlock();
    } else {
        endSession();
    }
}

</script>
</body>
</html>
